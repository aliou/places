PlaceMap.module('Views', function(Module, App, Backbone, Marionette, $, _) {
  Module.MapView = Backbone.Marionette.ItemView.extend({

    el: '#map',
    template: false,

    ui: {
      'locateMe': '#find-me',
    },

    events: {
      'click @ui.locateMe': 'locateUser',
    },

    initialize: function(options) {
      this.collection = options.collection;
      this.config = { center: [48.85, 2.35], zoom: 13 };

      L.mapbox.accessToken = "<%= ENV['MAPBOX_PUBLIC_TOKEN'] %>";

      _.bindAll(this, 'locateUser', 'setUserLocation',
                'showCollection', 'updateCollection',
                'featureClick');
    },

    onRender: function() {
      this.map = L.mapbox.map('map', 'examples.map-i86nkdio')
                         .setView(this.config.center, this.config.zoom)

      // Set events on the leaflet map object.
      this.map.on('locationfound', this.setUserLocation);
      this.map.on('locationerror', this.updateCollection);
      this.map.on('moveend',       this.updateCollection);

      // Initial collection fetch on the user location.
      this.locateUser()
    },

    updateCollection: function(event) {
      if (event) {
        this.config = {
          center: [this.map.getCenter().lat, this.map.getCenter().lng],
          zoom:   this.map.getZoom()
        };
      }

      this.collection.fetch({
        data:    $.param({ origin: this.config.center, zoom: this.config.zoom }),
        success: this.showCollection
      });
    },

    showCollection: function(collection, response, options) {
      this.collection.forEach(function(place) {
        var layer = place.toFeatureLayer();
        layer.on('click', this.featureClick);
        layer.addTo(this.map);
      }, this)
    },

    locateUser: function() {
      if (navigator.geolocation) {
        this.map.locate()
      }
    },

    setUserLocation: function(event) {
      this.map.setView([event.latitude, event.longitude], 13)

      L.mapbox.featureLayer({
        type:       'Feature',
        geometry:   {
          type:        'Point',
          coordinates: [event.longitude, event.latitude]
        },
        properties: {
          title:           'Current Location',
          'marker-color':  '#BE9A6B',
          'marker-symbol': 'star',
        }
      }).addTo(this.map)
      this.updateCollection(event);
    },

    // TODO: Get the map view in its new place.
    // TODO: Show close button.
    // TODO: Add close event that puts the view back in its regular place.
    featureClick: function(event) {
      var place = this.collection.get(event.layer.feature.properties.placeId);
      PlaceMap.router.navigate(place.url(), { trigger: true });
    },

  });
});
